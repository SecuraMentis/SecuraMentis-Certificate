<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SecuraMentis Abschluss</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<script>
window.onload = function () {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape" });

  /* -------- 1) Daten holen ------------- */
  const p   = new URLSearchParams(window.location.search);
  const kap1 = p.get("k1"), kap2 = p.get("k2"), kap3 = p.get("k3"),
        kap4 = p.get("k4"), kap5 = p.get("k5"),
        score = p.get("score"), leitsatz = p.get("leitsatz");
  const F = v => v ? v : "—";

  /* -------- 2) Vorlage laden ------------ */
  const bg = new Image();
  bg.src   = "SecuraMentis_Certificate_Template.png";          // liegt im selben Ordner
  bg.onload = () => {
    /* a) Vorlage mittig skalieren */
    const pw = doc.internal.pageSize.getWidth();   // 297 mm
    const ph = doc.internal.pageSize.getHeight();  // 210 mm
    const r  = bg.width / bg.height;
    let w = pw, h = pw / r;
    if (h > ph) { h = ph; w = ph * r; }
    const x0 = (pw - w) / 2;
    const y0 = (ph - h) / 2;

    doc.addImage(bg, "PNG", x0, y0, w, h);

    /* b) Textblock koordiniert zum linken Rahmen der Vorlage */
    const tx = x0 + 20;      // 20 mm Abstand vom linken Innenrand
    let   ty = y0 + 60;      // erste Zeile 60 mm unter dem oberen Innenrand
    const line = l => { doc.text(l, tx, ty); ty += 7; };

    doc.setFont("helvetica","normal"); doc.setFontSize(12);
    line(`Kapitel 1 abgeschlossen am: ${F(kap1)}`);
    line(`Kapitel 2 abgeschlossen am: ${F(kap2)}`);
    line(`Kapitel 3 abgeschlossen am: ${F(kap3)}`);
    line(`Kapitel 4 abgeschlossen am: ${F(kap4)}`);
    line(`Kapitel 5 abgeschlossen am: ${F(kap5)}`);
    ty += 5;
    line(`Quiz-Score: ${F(score)}`);

    ty += 10;
    doc.setFont("helvetica","italic"); doc.setFontSize(11);
    line("Dein persönlicher Leitsatz:");
    doc.setFontSize(10);
    doc.text(doc.splitTextToSize(F(leitsatz), 100), tx, ty + 6);

    /* c) Signatur einfügen und DANACH speichern */
    const sig = new Image();
    sig.src = "Signature.png";
    sig.onload = () => {
      doc.addImage(sig, "PNG", x0 + w - 60, y0 + h - 35, 40, 20); // rechts-unten
      doc.save("SecuraMentis_Abschluss.pdf");
    };
  };
};
</script>
</body>
</html>
